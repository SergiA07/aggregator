name: Deploy API

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if CI passed and API or database files changed
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for API/Database changes
        id: changes
        if: github.event_name == 'workflow_run'
        uses: tj-actions/changed-files@v46
        with:
          files: |
            apps/api/src/**
            apps/api/package.json
            apps/api/tsconfig*.json
            apps/api/nest-cli.json
            apps/api/Dockerfile
            packages/database/**
          files_ignore: |
            **/*.md

      - name: Log change detection result
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ steps.changes.outputs.any_changed }}" == "true" ]; then
            echo "✅ API or database changes detected - will deploy"
            echo "Changed files:"
            echo "${{ steps.changes.outputs.all_changed_files }}"
          else
            echo "⏭️ No API or database changes - skipping deploy"
          fi

      - name: Install Railway CLI
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        run: railway up --service aggregator
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
