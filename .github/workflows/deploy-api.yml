name: Deploy API

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only deploy if CI passed and API or database files changed
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.head_branch == 'main')
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check for API/Database changes
        id: changes
        if: github.event_name == 'workflow_run'
        uses: tj-actions/changed-files@24d32ffd492484c1d75e0c0b894501ddb9d30d62 # v47
        with:
          files: |
            apps/api/src/**
            apps/api/package.json
            apps/api/tsconfig*.json
            apps/api/nest-cli.json
            apps/api/Dockerfile
            packages/database/**
          files_ignore: |
            **/*.md

      - name: Log change detection result
        if: github.event_name == 'workflow_run'
        run: |
          if [ "${{ steps.changes.outputs.any_changed }}" == "true" ]; then
            echo "✅ API or database changes detected - will deploy"
            echo "Changed files:"
            echo "${{ steps.changes.outputs.all_changed_files }}"
          else
            echo "⏭️ No API or database changes - skipping deploy"
          fi

      - name: Setup Bun
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        uses: oven-sh/setup-bun@3d267786b128fe76c2f16a390aa2448b815359f3 # v2
        with:
          bun-version: "1.3.6"

      - name: Install dependencies
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        run: bun install

      - name: Run database migrations
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        working-directory: packages/database
        run: bunx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Install Railway CLI
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        run: npm install -g @railway/cli@4.15.1

      - name: Deploy to Railway
        if: github.event_name == 'workflow_dispatch' || steps.changes.outputs.any_changed == 'true'
        run: railway up --service aggregator
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
